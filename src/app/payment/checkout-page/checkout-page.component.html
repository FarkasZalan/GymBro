<!-- loading spinner -->
<app-loading-spinner *ngIf="loadingService.loading$ | async" [overlay]="true"></app-loading-spinner>

<div class="container" [@zoomIn]>
    <!-- Login Section -->
    <div class="login-prompt-container" *ngIf="!userLoggedIn" @fadeSlide>
        <div class="login-prompt">
            <div class="login-content">
                <div class="login-info">
                    <nb-icon icon="person-outline" class="login-icon"></nb-icon>
                    <p class="login-text">
                        {{ 'checkout.login.alreadyMember' | translate }}
                        <a (click)="navigateToLogin()" class="login-link">{{ 'checkout.login.loginHere' | translate
                            }}</a>
                        {{ 'checkout.login.or' | translate }}
                        <a (click)="navigateToRegister()" class="login-link">{{ 'checkout.login.createAccount' |
                            translate }}</a>
                        {{ 'checkout.login.forBetterExperience' | translate }}
                    </p>
                    <ul class="benefits-list">
                        <li>
                            <nb-icon icon="checkmark-circle-2-outline"></nb-icon>
                            {{ 'checkout.login.benefit1' | translate }}
                        </li>
                        <li>
                            <nb-icon icon="checkmark-circle-2-outline"></nb-icon>
                            {{ 'checkout.login.benefit2' | translate }}
                        </li>
                        <li>
                            <nb-icon icon="checkmark-circle-2-outline"></nb-icon>
                            {{ 'checkout.login.benefit3' | translate }}
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <nb-card class="checkout-container">
        <nb-card-header>
            <div class="header-content">
                <h2>
                    {{ 'checkout.title' | translate }}
                </h2>
            </div>
        </nb-card-header>

        <nb-card-body>
            <!-- Items Section -->
            <div class="checkout-section order-summary">
                <h3>
                    {{ 'checkout.orderSummary.title' | translate }}
                </h3>
                <div class="cart-items-section">
                    <div *ngFor="let item of visibleCartItems" class="cart-item" [@collapseFields] #cartItems
                        (click)="goToProduct(item)">
                        <div class="item-image">
                            <img *ngIf="item.selectedPrice.productImage" [src]="item.selectedPrice.productImage"
                                [alt]="item.productName">
                            <img *ngIf="!item.selectedPrice.productImage" src="../../../assets/images/gym-bro-logo.png"
                                alt="Product Image">
                        </div>

                        <div class="item-details">
                            <h4>{{item.productName}}</h4>
                            <div class="item-attributes">
                                <!-- size -->
                                <span *ngIf="item.selectedPrice.productSize" class="attribute">
                                    <nb-icon icon="cube-outline"></nb-icon>
                                    {{item.selectedPrice.productSize | translate}} {{item.selectedPrice.productUnit |
                                    translate}}
                                </span>
                                <!-- color -->
                                <span *ngIf="item.selectedPrice.productColor" class="attribute">
                                    <nb-icon icon="color-palette-outline"></nb-icon>
                                    {{item.selectedPrice.productColor | translate}}
                                </span>
                                <!-- flavor -->
                                <span *ngIf="item.selectedPrice.productFlavor" class="attribute">
                                    <nb-icon icon="star-outline"></nb-icon>
                                    {{item.selectedPrice.productFlavor | translate}}
                                </span>
                                <!-- quantity -->
                                <span class="attribute">
                                    <nb-icon icon="shopping-cart-outline"></nb-icon>
                                    x{{item.quantity}}
                                </span>
                            </div>
                        </div>

                        <div class="item-price">
                            <div class="price-tag">
                                {{item.selectedPrice.discountedPrice > 0
                                ? (item.selectedPrice.discountedPrice * item.quantity)
                                : (item.selectedPrice.productPrice * item.quantity) | currency:'':'':'1.0-0'}} {{
                                'products.huf' | translate }}
                            </div>
                            <div class="unit-price">
                                {{item.selectedPrice.discountedPrice > 0
                                ? (item.selectedPrice.discountedPrice)
                                : (item.selectedPrice.productPrice) | currency:'':'':'1.0-0'}} {{
                                'products.huf' | translate }}/{{ 'cart.item'
                                | translate }}
                            </div>
                        </div>
                    </div>

                    <!-- Show more/less button -->
                    <div *ngIf="cartItems.length > initialCartItemCount" class="show-more-container">
                        <button class="btn btn-primary show-more-button" (click)="toggleCartItemsDisplay()">
                            {{ (showAllCartItems ? 'cart.showLess' : 'cart.showMore') | translate }}
                            {{ showAllCartItems ? '' : ' (' + (cartItems.length - initialCartItemCount) +
                            ')' }}
                        </button>
                    </div>
                </div>

                <!-- edit cart button -->
                <div class="button-container">
                    <button nbButton status="success" class="proceed-btn btn" (click)="editCart()">
                        {{ 'checkout.actions.editCart' | translate }}
                    </button>
                </div>
            </div>

            <!-- Loyalty Preview Section -->
            <div class="checkout-section loyalty-preview" *ngIf="userLoggedIn" @fadeIn (click)="openLoyalityProgram()">
                <h3 class="loyalty-title">
                    <nb-icon icon="star-outline" class="loyalty-icon"></nb-icon>
                    {{ 'checkout.loyalty.title' | translate }}
                </h3>
                <div class="loyalty-content">
                    <div class="points-preview">
                        <div class="points-circle">
                            <span class="points-number">+{{calculateLoyaltyPoints()}}</span>
                            <span class="points-label">{{ 'checkout.loyalty.points' | translate }}</span>
                        </div>
                    </div>
                    <div class="points-info">
                        <p>{{ 'checkout.loyalty.earnPoints' | translate }}</p>
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress" [style.width]="getLoyaltyProgress() + '%'"></div>
                            </div>
                            <div class="progress-labels">
                                <span>{{currentLoyaltyPoints}}</span>
                                <span>{{nextRewardThreshold}}</span>
                            </div>
                        </div>
                        <p class="next-reward" *ngIf="getPointsToNextReward() > 0">
                            <nb-icon icon="gift-outline"></nb-icon>
                            {{ 'checkout.loyalty.nextReward' | translate: { points: getPointsToNextReward() } }}
                        </p>
                    </div>
                </div>
            </div>

            <!-- Shipping Methods Section -->
            <div class="checkout-section shipping-methods">
                <h3>
                    {{ 'checkout.shipping.title' | translate }}
                </h3>

                <div class="shipping-options">
                    <div *ngFor="let method of shippingMethods" class="shipping-option"
                        [class.selected]="selectedShippingMethod === method.id"
                        (click)="selectShippingMethod(method.id)">
                        <div class="shipping-icon">
                            <nb-icon [icon]="method.icon"></nb-icon>
                        </div>
                        <div class="shipping-details">
                            <div class="shipping-name">{{ method.name | translate }}</div>
                            <div class="shipping-description">{{ method.description | translate }}</div>
                            <div class="shipping-info">
                                <span class="delivery-time">
                                    <nb-icon icon="clock-outline"></nb-icon>
                                    {{ 'checkout.shipping.estimatedDays' | translate:{ days: method.estimatedDays } }}
                                </span>
                                <span class="shipping-price">
                                    <nb-icon icon="pricetags-outline"></nb-icon>
                                    {{ method.price === 0 ? ('checkout.shipping.free' | translate) :
                                    (method.price | currency:'':'':'1.0-0') + ' ' + ('products.huf' | translate) }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Methods Section -->
            <div class="checkout-section payment-methods">
                <h3>
                    {{ 'checkout.payment.title' | translate }}
                </h3>
                <div class="payment-options">
                    <div *ngFor="let method of paymentMethods" class="payment-option"
                        [class.selected]="selectedPaymentMethod === method.id" (click)="selectPaymentMethod(method.id)">
                        <div class="payment-icon">
                            <nb-icon [icon]="method.icon"></nb-icon>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">{{ method.name | translate}}</div>
                            <div class="payment-description">{{ method.description | translate}}</div>
                            <div class="payment-fee" *ngIf="method.additionalFee > 0">
                                <nb-icon icon="alert-circle-outline"></nb-icon>
                                {{ 'checkout.payment.additionalFee' | translate:{ fee: method.additionalFee } }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Shipping Address Section -->
            <div class="shipping-address" *ngIf="shippingAddress && !displayGuestForm" @fadeInUp>
                <h3>
                    {{ shippingAddress.companyName || selectedShippingMethod ===
                    productViewText.CHECKOUT_SHIPPING_STORE_PICKUP_TITLE
                    ? ('profileMenu.shippingAddressForm.billingAddress' | translate)
                    : ('checkout.shippingAddress.title' | translate) }}
                </h3>
                <div class="address-container">
                    <nb-card class="rounded-card addressCard">
                        <nb-card-header class="card-header">
                            <nb-icon class="card-icon" icon="pin-outline"></nb-icon>
                            <strong>{{ shippingAddress.addressName | translate }}</strong>
                        </nb-card-header>
                        <nb-card-body class="address-details">
                            <!-- Billing Address Section -->
                            <!-- billing same as shipping -->
                            <div *ngIf="shippingAddress.companyName &&!shippingAddress.isBillingDifferentFromShipping">
                                <p>{{ shippingAddress.street }} {{
                                    shippingAddress.streetType }}, {{
                                    shippingAddress.houseNumber }}</p>
                                <p>{{ shippingAddress.floor ? (shippingAddress.floor +
                                    '/') : '' }}{{ shippingAddress.door }}</p>
                                <p>{{ shippingAddress.city }}, {{
                                    shippingAddress.postalCode }}</p>
                                <p>{{ shippingAddress.country }}</p>
                            </div>

                            <!-- billing different from shipping -->
                            <div *ngIf="shippingAddress.companyName && shippingAddress.isBillingDifferentFromShipping">
                                <p>{{ shippingAddress.billingAddress.street }} {{
                                    shippingAddress.billingAddress.streetType }}, {{
                                    shippingAddress.billingAddress.houseNumber }}</p>
                                <p>{{ shippingAddress.billingAddress.floor ? (shippingAddress.billingAddress.floor +
                                    '/') : '' }}{{ shippingAddress.billingAddress.door }}</p>
                                <p>{{ shippingAddress.billingAddress.city }}, {{
                                    shippingAddress.billingAddress.postalCode }}</p>
                                <p>{{ shippingAddress.billingAddress.country }}</p>
                            </div>

                            <!-- Company details if they exist -->
                            <p *ngIf="shippingAddress.companyName">
                                <strong>{{ 'profileMenu.shippingAddressForm.companyName' | translate }}:</strong>
                                {{ shippingAddress.companyName }}
                            </p>
                            <p *ngIf="shippingAddress.taxNumber">
                                <strong>{{ 'profileMenu.shippingAddressForm.taxNumber' | translate }}:</strong>
                                {{ shippingAddress.taxNumber }}
                            </p>

                            <!-- Shipping address section -->
                            <!-- shipping address if don't have billing address -->
                            <div *ngIf="!shippingAddress.companyName">
                                <p>{{ shippingAddress.street }} {{ shippingAddress.streetType }}, {{
                                    shippingAddress.houseNumber }}</p>
                                <p>{{ shippingAddress.floor ? (shippingAddress.floor + '/') : '' }}{{
                                    shippingAddress.door
                                    }}</p>
                                <p>{{ shippingAddress.city }}, {{ shippingAddress.postalCode }}</p>
                                <p>{{ shippingAddress.country }}</p>
                            </div>

                            <!--shipping address if have billing address -->
                            <div
                                *ngIf="shippingAddress.companyName && selectedShippingMethod !== productViewText.CHECKOUT_SHIPPING_STORE_PICKUP_TITLE">
                                <div class="billing-address-section">
                                    <h5>{{ 'checkout.shippingAddress.title' | translate }}</h5>
                                    <p>{{ shippingAddress.street }} {{ shippingAddress.streetType }}, {{
                                        shippingAddress.houseNumber }}</p>
                                    <p>{{ shippingAddress.floor ? (shippingAddress.floor + '/') : '' }}{{
                                        shippingAddress.door
                                        }}</p>
                                    <p>{{ shippingAddress.city }}, {{ shippingAddress.postalCode }}</p>
                                    <p>{{ shippingAddress.country }}</p>
                                </div>
                            </div>
                        </nb-card-body>
                        <nb-card-footer>
                            <button *ngIf="userLoggedIn" class="change-address-btn"
                                (click)="editAddress(shippingAddress.id)">
                                <nb-icon icon="edit-2-outline"></nb-icon>
                                {{ 'checkout.shippingAddress.changeAddress' | translate }}
                            </button>

                            <button *ngIf="!userLoggedIn" class="change-address-btn" (click)="editGuestForm()">
                                <nb-icon icon="edit-2-outline"></nb-icon>
                                {{ 'checkout.shippingAddress.changeAddress' | translate }}
                            </button>
                        </nb-card-footer>
                    </nb-card>
                </div>
            </div>

            <!-- No Address Prompt for Logged In Users -->
            <div *ngIf="userLoggedIn && !shippingAddress" class="no-address" @fadeIn>
                <div class="no-address-content">
                    <nb-icon icon="map-outline"></nb-icon>
                    <p>{{ 'checkout.shippingAddress.noAddress' | translate }}</p>
                    <button class="select-address-btn" nbButton status="primary" (click)="openAddressSelection()">
                        <nb-icon icon="pin-outline"></nb-icon>
                        {{ 'checkout.shippingAddress.selectAddress' | translate }}
                    </button>
                </div>
            </div>

            <!-- Guest Shipping Address Form -->
            <div class="shipping-address-form" *ngIf="displayGuestForm" @fadeSlide>
                <h3>
                    {{ 'checkout.guestAddressName' | translate }}
                </h3>
                <form (ngSubmit)="addNewGuestAddress()" #form="ngForm">
                    <!-- Name block -->
                    <div class="row">
                        <div class="col-md-6">
                            <!-- First Name block -->
                            <div class="form-group">
                                <label for="firstName" class="label">{{ 'register.firstName' | translate }}</label>
                                <input type="text" class="form-control" [(ngModel)]="guestFirstName" name="firstName"
                                    minlength="1" required placeholder="{{ 'register.firstName' | translate }}*"
                                    #firstName="ngModel">
                                <span class="help-block" *ngIf="firstName.touched && !firstName.valid" [@zoomIn]>{{
                                    'register.fieldRequired' | translate }}</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <!-- Last Name block -->
                            <div class="form-group">
                                <label for="lastName" class="label">{{ 'register.lastName' | translate }}</label>
                                <input type="text" class="form-control" [(ngModel)]="guestLastName" name="lastName"
                                    minlength="1" required placeholder="{{ 'register.lastName' | translate }}*"
                                    #lastName="ngModel">
                                <span class="help-block" *ngIf="lastName.touched && !lastName.valid" [@zoomIn]>{{
                                    'register.fieldRequired' | translate }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <!-- Email block -->
                            <div class="form-group">
                                <label for="email" class="label">{{ 'loginPage.email' | translate }}</label>
                                <input type="email" class="form-control" [(ngModel)]="guestEmail" name="email" required
                                    placeholder="{{ 'loginPage.emailAddress' | translate }}*" #email="ngModel">
                                <span class="help-block" *ngIf="email.touched && !email.valid" [@zoomIn]>{{
                                    'loginPage.invalidEmail' | translate }}</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <!-- Phone block -->
                            <div class="form-group">
                                <label for="phone" class="label">{{ 'register.phone' | translate }}</label>
                                <input type="tel" class="form-control" [(ngModel)]="guestPhone" name="phone" required
                                    placeholder="{{ 'register.phone' | translate }}*" #phone="ngModel">
                                <span class="help-block" *ngIf="phone.touched && !phone.valid" [@zoomIn]>{{
                                    'register.fieldRequired' | translate }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Shipping Address block -->
                    <div class="row">
                        <div class="col-md-8">
                            <!-- Country block -->
                            <div class="form-group">
                                <label for="country" class="label">{{ 'profileMenu.shippingAddressForm.country' |
                                    translate }}</label>
                                <input type="text" class="form-control" [(ngModel)]="shippingAddress.country"
                                    name="country" minlength="1" required
                                    placeholder="{{ 'profileMenu.shippingAddressForm.country' | translate }}*"
                                    #country="ngModel">
                                <span class="help-block" *ngIf="country.touched && !country.valid">{{
                                    'register.fieldRequired' | translate }}</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <!-- Postal code block -->
                            <div class="form-group">
                                <label for="postalCode" class="label">{{
                                    'profileMenu.shippingAddressForm.postalCode' | translate }}</label>
                                <input type="text" class="form-control" [(ngModel)]="shippingAddress.postalCode"
                                    name="postalCode" minlength="1" required
                                    placeholder="{{ 'profileMenu.shippingAddressForm.postalCode' | translate }}*"
                                    #postalCode="ngModel">
                                <span class="help-block" *ngIf="postalCode.touched && !postalCode.valid">{{
                                    'register.fieldRequired' | translate }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <!-- City block -->
                            <div class="form-group">
                                <label for="city" class="label">{{
                                    'profileMenu.shippingAddressForm.city' | translate }}</label>
                                <input type="text" class="form-control" [(ngModel)]="shippingAddress.city" name="city"
                                    required placeholder="{{ 'profileMenu.shippingAddressForm.city' | translate }}*"
                                    #city="ngModel">
                                <span class="help-block" *ngIf="city.touched && !city.valid">{{
                                    'register.fieldRequired' | translate }}</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <!-- Street block -->
                            <div class="form-group">
                                <label for="streetName" class="label">{{
                                    'profileMenu.shippingAddressForm.streetName' | translate }}</label>
                                <input type="text" class="form-control" [(ngModel)]="shippingAddress.street"
                                    name="streetName" required
                                    placeholder="{{ 'profileMenu.shippingAddressForm.streetName' | translate }}*"
                                    #streetName="ngModel">
                                <span class="help-block" *ngIf="streetName.touched && !streetName.valid">{{
                                    'register.fieldRequired' | translate }}</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <!-- Street type block -->
                            <div class="form-group">
                                <label for="streetType" class="label">{{
                                    'profileMenu.shippingAddressForm.streetType' | translate }}</label>
                                <input type="text" class="form-control" [(ngModel)]="shippingAddress.streetType"
                                    name="streetType" required
                                    placeholder="{{ 'profileMenu.shippingAddressForm.streetType' | translate }}*"
                                    #streetType="ngModel">
                                <span class="help-block" *ngIf="streetType.touched && !streetType.valid">{{
                                    'register.fieldRequired' | translate }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <!-- House number block -->
                            <div class="form-group">
                                <label for="houseNumber" class="label">{{
                                    'profileMenu.shippingAddressForm.houseNumber' | translate }}</label>
                                <input type="text" class="form-control" [(ngModel)]="shippingAddress.houseNumber"
                                    name="houseNumber" required
                                    placeholder="{{ 'profileMenu.shippingAddressForm.houseNumber' | translate }}*"
                                    #houseNumber="ngModel">
                                <span class="help-block" *ngIf="houseNumber.touched && !houseNumber.valid">{{
                                    'register.fieldRequired' | translate }}</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <!-- Floor block -->
                            <div class="form-group">
                                <label for="floor" class="label">{{ 'profileMenu.shippingAddressForm.floor' |
                                    translate }}</label>
                                <input type="number" class="form-control" [(ngModel)]="shippingAddress.floor"
                                    name="floor" placeholder="{{ 'profileMenu.shippingAddressForm.floor' |
                                    translate }}" #floor="ngModel">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <!-- Door block -->
                            <div class="form-group">
                                <label for="door" class="label">{{ 'profileMenu.shippingAddressForm.door' |
                                    translate }}</label>
                                <input type="number" class="form-control" min="1" [(ngModel)]="shippingAddress.door"
                                    name="door" placeholder="{{ 'profileMenu.shippingAddressForm.door' | translate }}"
                                    #door="ngModel">
                                <span class="help-block" *ngIf="door.touched && !door.valid">{{
                                    'profileMenu.shippingAddressForm.fieldIncorrect' | translate }}</span>
                            </div>
                        </div>
                    </div>
                    <!-- company address Checkbox -->
                    <div style="margin-top: 10px; margin-bottom: 10px;" class="form-group">
                        <label for="companyAddress" class="checkbox-container">
                            <label for="companyAddress">{{ 'profileMenu.shippingAddressForm.setAsCompanyAddress'
                                | translate }}
                            </label>
                            <input type="checkbox" [(ngModel)]="isCompanyAddressChecked" name="companyAddress"
                                id="companyAddress" #admin="ngModel">
                            <span class="checkmark"></span>
                        </label>
                    </div>
                    <div *ngIf="isCompanyAddressChecked" [@collapseFields] class="row">
                        <div class="col-md-6">
                            <!-- Company name block -->
                            <div class="form-group">
                                <label for="companyName" class="label">{{
                                    'profileMenu.shippingAddressForm.companyName' |
                                    translate }}</label>
                                <input type="text" class="form-control" [(ngModel)]="shippingAddress.companyName"
                                    name="companyName" minlength="1" required
                                    placeholder="{{ 'profileMenu.shippingAddressForm.companyName' | translate }}*"
                                    #companyName="ngModel">
                                <span class="help-block" *ngIf="companyName.touched && !companyName.valid">{{
                                    'register.fieldRequired' | translate }}</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <!-- Tax number block -->
                            <div class="form-group">
                                <label for="taxNumber" class="label">{{
                                    'profileMenu.shippingAddressForm.taxNumber' | translate }}</label>
                                <input type="text" class="form-control" [(ngModel)]="shippingAddress.taxNumber"
                                    name="taxNumber" minlength="1" required
                                    placeholder="{{ 'profileMenu.shippingAddressForm.taxNumber' | translate }}*"
                                    #taxNumber="ngModel">
                                <span class="help-block" *ngIf="taxNumber.touched && !taxNumber.valid">{{
                                    'register.fieldRequired' | translate }}</span>
                            </div>
                        </div>

                        <!-- Billing address section -->
                        <!-- billing address same as shipping Checkbox -->
                        <div style="margin-top: 10px; margin-bottom: 10px;" class="form-group">
                            <label for="setToDefaultAddress" class="checkbox-container">
                                <label for="setToDefaultAddress">{{
                                    'profileMenu.shippingAddressForm.billingAddressSameAsShipping' |
                                    translate }}
                                </label>
                                <input type="checkbox" [(ngModel)]="shippingAddress.isBillingDifferentFromShipping"
                                    name="setToDefaultAddress" id="setToDefaultAddress" #admin="ngModel">
                                <span class="checkmark"></span>
                            </label>
                        </div>
                        <!-- billing address details -->
                        <div *ngIf="shippingAddress.isBillingDifferentFromShipping" [@collapseFields]
                            class="row billing-address-form ">
                            <div [@collapseFields] class="row">
                                <div class="col-md-8">
                                    <!-- Billing Country block -->
                                    <div class="form-group">
                                        <label for="billingCountry" class="label">{{
                                            'profileMenu.shippingAddressForm.country'
                                            |
                                            translate }}</label>
                                        <input type="text" class="form-control"
                                            [(ngModel)]="shippingAddress.billingAddress.country" name="billingCountry"
                                            minlength="1" required
                                            placeholder="{{ 'profileMenu.shippingAddressForm.country' | translate }}*"
                                            #billingCountry="ngModel">
                                        <span class="help-block"
                                            *ngIf="billingCountry.touched && !billingCountry.valid">{{
                                            'register.fieldRequired' | translate }}</span>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <!-- Postal code block -->
                                    <div class="form-group">
                                        <label for="billingPostalCode" class="label">{{
                                            'profileMenu.shippingAddressForm.postalCode' | translate }}</label>
                                        <input type="text" class="form-control"
                                            [(ngModel)]="shippingAddress.billingAddress.postalCode"
                                            name="billingPostalCode" minlength="1" required
                                            placeholder="{{ 'profileMenu.shippingAddressForm.postalCode' | translate }}*"
                                            #billingPostalCode="ngModel">
                                        <span class="help-block"
                                            *ngIf="billingPostalCode.touched && !billingPostalCode.valid">{{
                                            'register.fieldRequired' | translate }}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <!-- City block -->
                                    <div class="form-group">
                                        <label for="billingCity" class="label">{{
                                            'profileMenu.shippingAddressForm.city' | translate }}</label>
                                        <input type="text" class="form-control"
                                            [(ngModel)]="shippingAddress.billingAddress.city" name="billingCity"
                                            required
                                            placeholder="{{ 'profileMenu.shippingAddressForm.city' | translate }}*"
                                            #billingCity="ngModel">
                                        <span class="help-block" *ngIf="billingCity.touched && !billingCity.valid">{{
                                            'register.fieldRequired' | translate }}</span>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <!-- Street block -->
                                    <div class="form-group">
                                        <label for="billingStreetName" class="label">{{
                                            'profileMenu.shippingAddressForm.streetName' | translate }}</label>
                                        <input type="text" class="form-control"
                                            [(ngModel)]="shippingAddress.billingAddress.street" name="billingStreetName"
                                            required
                                            placeholder="{{ 'profileMenu.shippingAddressForm.streetName' | translate }}*"
                                            #billingStreetName="ngModel">
                                        <span class="help-block"
                                            *ngIf="billingStreetName.touched && !billingStreetName.valid">{{
                                            'register.fieldRequired' | translate }}</span>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <!-- Street type block -->
                                    <div class="form-group">
                                        <label for="billingStreetType" class="label">{{
                                            'profileMenu.shippingAddressForm.streetType' | translate }}</label>
                                        <input type="text" class="form-control"
                                            [(ngModel)]="shippingAddress.billingAddress.streetType"
                                            name="billingStreetType" required
                                            placeholder="{{ 'profileMenu.shippingAddressForm.streetType' | translate }}*"
                                            #billingStreetType="ngModel">
                                        <span class="help-block"
                                            *ngIf="billingStreetType.touched && !billingStreetType.valid">{{
                                            'register.fieldRequired' | translate }}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <!-- House number block -->
                                    <div class="form-group">
                                        <label for="billingHouseNumber" class="label">{{
                                            'profileMenu.shippingAddressForm.houseNumber' | translate }}</label>
                                        <input type="text" class="form-control"
                                            [(ngModel)]="shippingAddress.billingAddress.houseNumber"
                                            name="billingHouseNumber" required
                                            placeholder="{{ 'profileMenu.shippingAddressForm.houseNumber' | translate }}*"
                                            #billingHouseNumber="ngModel">
                                        <span class="help-block"
                                            *ngIf="billingHouseNumber.touched && !billingHouseNumber.valid">{{
                                            'register.fieldRequired' | translate }}</span>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <!-- Floor block -->
                                    <div class="form-group">
                                        <label for="billingFloor" class="label">{{
                                            'profileMenu.shippingAddressForm.floor'
                                            |
                                            translate }}</label>
                                        <input type="number" class="form-control"
                                            [(ngModel)]="shippingAddress.billingAddress.floor" name="billingFloor"
                                            placeholder="{{ 'profileMenu.shippingAddressForm.floor' | translate }}"
                                            #billingFloor="ngModel">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <!-- Door block -->
                                    <div class="form-group">
                                        <label for="billingDoor" class="label">{{
                                            'profileMenu.shippingAddressForm.door' |
                                            translate }}</label>
                                        <input type="number" class="form-control"
                                            [(ngModel)]="shippingAddress.billingAddress.door" name="billingDoor"
                                            placeholder="{{ 'profileMenu.shippingAddressForm.door' | translate }}"
                                            #billingDoor="ngModel">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div><br>

                    <!-- new address submit button -->
                    <div class="button-container">
                        <button class="btn btn-primary basic-btn basic-form-btn" type="submit" nbButton status="success"
                            [disabled]="!form.valid">{{
                            isEditGuestForm ? ('profileMenu.shippingAddressForm.modifyAddress' | translate) :
                            ('profileMenu.shippingAddressForm.addAddress' | translate)
                            }}</button>
                    </div>
                </form>
            </div>

            <!-- Coupon Section -->
            <div *ngIf="userLoggedIn" @fadeInUp name="couponSection" id="couponSection" #couponSection>
                <nb-card class="rounded-card checkout-section rewards-section">
                    <nb-card-header>
                        <h3>
                            {{ 'checkout.availableRewards' | translate }}
                        </h3>
                    </nb-card-header>
                    <nb-card-body class="rewards-body">
                        <!-- Active Reward -->
                        <div class="active-reward" *ngIf="activeReward" @fadeSlide>
                            <div class="reward-card active">
                                <div class="reward-icon">
                                    <nb-icon [icon]="activeReward.icon"></nb-icon>
                                </div>
                                <div class="reward-content">
                                    <h4>{{activeReward.name | translate}}</h4>
                                    <p>{{activeReward.description | translate}}</p>
                                    <div class="button-container">
                                        <button nbButton class="remove-reward-btn btn" (click)="removeCoupon()">
                                            <nb-icon icon="close-circle-outline"></nb-icon>
                                            {{ 'checkout.removeReward' | translate }}
                                        </button>
                                    </div>
                                </div>
                                <div class="active-indicator">
                                    <nb-icon icon="checkmark-circle-2"></nb-icon>
                                    {{ 'checkout.active' | translate }}
                                </div>
                            </div>
                        </div>

                        <!-- Available Rewards -->
                        <div class="rewards-list"
                            *ngIf="!activeReward && displayAvailableRewardsBasedOnPoints.length > 0" @fadeSlide>
                            <div class="reward-card" *ngFor="let reward of displayAvailableRewardsBasedOnPoints"
                                (click)="activateCoupon(reward)">
                                <div class="reward-icon">
                                    <nb-icon [icon]="reward.icon"></nb-icon>
                                </div>
                                <div class="reward-content">
                                    <h4>{{reward.name | translate}}</h4>
                                    <p>{{reward.description | translate}}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Empty State -->
                        <div class="empty-rewards"
                            *ngIf="!activeReward && displayAvailableRewardsBasedOnPoints.length === 0" @fadeSlide>
                            <div class="empty-content">
                                <nb-icon icon="gift-outline"></nb-icon>
                                <h4>{{ 'checkout.rewards.noRewardsTitle' | translate }}</h4>
                                <p>{{ 'checkout.rewards.noRewardsMessage' | translate }}</p>
                                <button nbButton status="primary" (click)="openLoyalityProgram()">
                                    <nb-icon icon="star-outline"></nb-icon>
                                    {{ 'checkout.rewards.viewLoyaltyProgram' | translate }}
                                </button>
                            </div>
                        </div>
                    </nb-card-body>
                </nb-card>
            </div>

            <!-- Price Summary Section -->
            <div class="checkout-section price-summary">
                <h3>
                    {{ 'checkout.orderSummary.summary' | translate }}
                </h3>
                <div class="summary-row">
                    <span>
                        <nb-icon class="summary-icon" icon="shopping-cart-outline"></nb-icon>
                        {{ 'checkout.orderSummary.subtotal' | translate }}
                    </span>
                    <span class="total-cost">{{subtotal | currency:'':'':'1.0-0'}} {{ 'products.huf' | translate
                        }}</span>
                </div>
                <div class="summary-row shipping" *ngIf="selectedShippingMethod" @fadeInUp>
                    <span>
                        <nb-icon class="summary-icon" icon="car-outline"></nb-icon>
                        {{ 'checkout.orderSummary.shipping' | translate }}
                    </span>
                    <div class="shipping-cost" [class.free-shipping]="isFreeShippingActive()">
                        <span class="original-cost total-cost" *ngIf="isFreeShippingActive()">
                            {{ getOriginalShippingCost() | currency:'':'':'1.0-0' }} {{ 'products.huf' | translate }}
                        </span>
                        <span class="final-cost total-cost">
                            {{ isFreeShippingActive() ? '0' : shipping | currency:'':'':'1.0-0' }} {{ 'products.huf' |
                            translate }}
                        </span>
                    </div>
                </div>
                <div class="summary-row" *ngIf="cashOnDeliveryAmount > 0" @fadeInUp>
                    <span>
                        <nb-icon class="summary-icon" icon="credit-card-outline"></nb-icon>
                        {{ 'checkout.orderSummary.paymentFee' | translate }}
                    </span>
                    <span class="total-cost">{{cashOnDeliveryAmount | currency:'':'':'1.0-0'}} {{ 'products.huf' |
                        translate }}</span>
                </div>
                <div class="summary-row" *ngIf="discountAmount > 0">
                    <span>
                        <nb-icon class="summary-icon" icon="star-outline"></nb-icon>
                        {{ 'checkout.discount' | translate }}
                    </span>
                    <span class="discount">-{{discountAmount | currency:'':'':'1.0-0'}} {{ 'products.huf' | translate
                        }}</span>
                </div>
                <div class="summary-row total" [class.coupon-used]="couponUsed">
                    <span>
                        <nb-icon class="summary-icon" icon="checkmark-circle-2-outline"></nb-icon>
                        {{ 'checkout.orderSummary.total' | translate }}
                    </span>
                    <div class="total-cost" [class.discounted]="couponUsed">
                        <span class="original-cost" *ngIf="couponUsed">
                            {{ total | currency:'':'':'1.0-0' }} {{ 'products.huf' | translate }}
                        </span>
                        <span class="final-cost">
                            {{ calculateOriginalTotal() | currency:'':'':'1.0-0' }} {{ 'products.huf' | translate }}
                        </span>
                    </div>
                </div>

                <!-- Error block -->
                <span *ngIf="errorMessage" class="help-block-login-error" [@zoomIn]>
                    <i class="fas fa-exclamation-triangle icon"></i>
                    {{ 'basicErrorMessage' | translate }}
                </span>

                <!-- Minimum 2000 huf block -->
                <span *ngIf="minimum200HufError" class="help-block-login-error" [@zoomIn]>
                    <i class="fas fa-exclamation-triangle icon"></i>
                    {{ 'checkout.minimum2000HufError' | translate }}
                </span>

                <div class="button-container">
                    <button nbButton status="success" class="proceed-btn btn"
                        [disabled]="!selectedPaymentMethod || shippingAddress === null || !selectedShippingMethod"
                        (click)="proceedToPayment()">
                        <nb-icon icon="checkmark-circle-2-outline"></nb-icon>
                        {{ 'checkout.actions.placeOrder' | translate }}
                    </button>
                </div>
            </div>

            <!-- back button -->
            <div class="button-container">
                <button class="btn btn-primary basic-btn back-btn basic-form-btn" type="submit" nbButton
                    status="success" (click)="back()">
                    <span class="arrow">
                        <svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                            <!-- Filled left arrow -->
                            <path d="M26 6L14 16l12 10" fill="#0b8e92" />
                        </svg>
                    </span>
                    {{ 'loginPage.back' | translate }}
                </button>
            </div>
        </nb-card-body>
    </nb-card>
</div>